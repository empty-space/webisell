@model FilterPageViewModel
@using Webisell.Web.Controllers
@using Webisell.Web.ViewModels
@{
    ViewData["Title"] = "Home Page";
}
<div class="row">
    <form id="filter-form" asp-action="">
        <input type="hidden" name="CollectionName" value="products" />
        <input type="hidden" name="Category" value="@(Model.Category??"phone")" />
        <input type="hidden" name="Page" value="1" />
        <input type="hidden" name="PageSize" value="12" />
        <input type="hidden" name="Sorting.Field" value="price" />
        <input type="hidden" name="Sorting.Direction" value="-1" />
        <div class="col-md-3">
            <div class="text-center"><h3>Filters</h3></div>
            <div class="panel panel-body">
                <div class="btn-filter btn btn-lg btn-primary col-md-offset-1 col-md-4">Apply</div>
                <div class="btn-filter-clear btn btn-lg btn-default col-md-offset-2 col-md-4">Clear</div>
            </div>
            @{var i = 0;}
            @foreach (var filter in Model.Filters)
            {
                <div class="panel panel-primary filter">
                    <div class="panel-heading">@filter.Name</div>
                    <div class="panel-body" data-name="@filter.Name">
                        <input type="hidden" name="Filters[@i].Name" value="@filter.Name" />
                        <input type="hidden" name="Filters[@i].FilterType" value="@filter.FilterType" />

                        @if (filter.FilterType == Webisell.Web.Enums.EFilterType.Multiple_AND
|| filter.FilterType == Webisell.Web.Enums.EFilterType.Multiple_OR
|| filter.FilterType == Webisell.Web.Enums.EFilterType.Ranges)
                        {
                            foreach (var item in filter.Values)
                            {
                                <div class="checkbox">
                                    <label>
                                        <input type="checkbox" name="Filters[@i].Values[]" value="@item" />
                                        @item
                                    </label>
                                </div>
                            }
                        }
                        @if (filter.FilterType == Webisell.Web.Enums.EFilterType.Range)
                        {
                            @*<input type="number" id="textInput" value="">
                        <input type="range" name="@filter.Name"
                               min="" max="@filter.Max">*@
                            <input class="slider" type="number" id="slider-@filter.Name"
                                   data-slider-min="@filter.Min" data-slider-max="@filter.Max"
                                   data-slider-step="1" data-slider-value="14" />
                            <input type="hidden" id="slider-@filter.Name-max" name="Filters[@i].Max" value="10000" />
                            <input type="hidden" id="slider-@filter.Name-min" name="Filters[@i].Min" value="1" />
                        }
                    </div>
                </div>
                i++;
            }

            <div class="btn-filter btn btn-lg btn-primary col-md-offset-1 col-md-10">Apply filters</div>
        </div>


        <div class="col-md-9">
            <div class="text-center"><h3>Products</h3></div>
            <div class="panel panel-info"style="min-height:500px;">
                <div class="panel-heading">Search results <div id="search-count" class="badge"></div></div>
                <div class="panel-body">
                    
                    <div id="loading" class="col-md-12" style="text-align:center;position:absolute">
                        <span class="fa fa-3x fa-spinner fa-spin"></span>
                    </div>
                    <div id="results"><h3></h3></div>
                    
                    <div class="col-md-12 col-sm-12 col-lg-12">
                        <div id="pagination" class="col-md-10"></div>

                        @*<div class="btn-group col-md-2">
                <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    10 <span class="caret"></span>
                </button>
                <ul class="dropdown-menu">
                    <li><span click="setPageSize(10)">10</span></li>
                    <li><span click="setPageSize(20)">20</span></li>
                    <li><span click="setPageSize(50)">50</span></li>
                </ul>
            </div>*@
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts{
    <script>
        var priceSlider = $(".slider").slider({
            focus: true,
            range: true,
            min: 1,
            max: 10000,
            ticks: [1, 10000],
            //ticks_positions: [0, 100],
            ticks_labels: ['$1', '$10000']
            //,
            //value: [3, 7]
        }).on('slideStop', (e) => {
            //console.log($(e.target).next("#" + e.target.id + "-min"))
            console.log($("#" + e.target.id + "-min"))
            console.log(e.value)
            $("#" + e.target.id + "-min").val(e.value[0])
            $("#" + e.target.id + "-max").val(e.value[1])
            // console.log(e)
        });
    </script>
    <script>
        function getFormData() {
            var range = priceSlider.slider('getValue')
            return {
                filters: [
                    {
                        "filterType": 0,
                        "name": "manufacturer",
                        "values": [
                            "Apple",
                            "Blackberry"
                        ],
                        "min": null,
                        "max": null
                    }],
                min: range[0],
                max: range[1],
                filters:null
            }
        }
        function doFilterSearch (){
            var formData = $('#filter-form').serialize()
            console.log(formData)
            hideResults()
            hidePagination()
            showLoading()
            //console.log(priceSlider.slider('getValue'))
            $.ajax({
                type: "POST",
                url: "@Url.Action(nameof(ProductsController.FilterProducts))",
                data: formData,
                //dataType: "application/x-www-form-urlencoded",
                success: function (data) {
                    console.log("success")
                    console.log(data)
                    updatePagination(data.count, getPage())
                    $("#search-count").html(data.count)
                    showResults(JSON.parse(data.filteredResults))                   
                },
                error: function (err) {
                    console.error(err)                    
                }
            })
            .always(() => showLoading(false));
        }
        function showLoading(show=true) {
            if (show)
                $("#loading").fadeIn()
            else
                $("#loading").fadeOut()
        }
        function hideResults() {
            var resultsBlock = $("#results")
            $("#search-count").empty()
            resultsBlock.fadeOut(100, () => resultsBlock.empty());
        }
        function showResults(data) {            
            var resultsBlock = $("#results")
            if (data.length > 0) {
                for (var item of data) {
                    resultsBlock.append(buildItemCard(item))
                }
            }
            else {
                resultsBlock.append($("<h3>").html("No items for this criteria"))
            }
            resultsBlock.fadeIn()
        }
        function buildItemCard(item) {
            //var card = $("<div/>").addClass("card col-md-2")
            var card = $(`
    <div class="col-sm-4 col-md-3">
    <div class="thumbnail">
      <img src="/images/test_image.png" alt="...">
      <div class="caption">
        <h5>${item.product_name}</h5>
    <h6>$${item.price}</h6>
        <p>
        <a href="/Products/Details/${item.product_id}" class="btn btn-default " role="button">Details</a>
        <a href="#" class="btn btn-default disabled pull-right" role="button"><span class="fa fa-balance-scale"></span></a>    
    </p>
      </div>
    </div>
  </div>`)
            //card.append(item.product_name)
            return card;
        }

        function hidePagination() {
            $("#pagination").empty()
        }

        function updatePagination(count, current) {
            current = Number(current)
            count = Number(count)
            var pages = ""
            let maxPage = count / getPageSize();
            if (maxPage < 1)
                return
            let pagingbegin = current - 5 > 0 ? current - 5 : 1;
            let pagingend = current + 5 < maxPage ? current + 5 : maxPage;

            for (var i = pagingbegin - 1; i < pagingend; i++) {
                var disabled=''
                if (i == current-1)
                    disabled = 'active'
                pages += `<li class='${disabled}'><a href="#" onclick="gotoPageClick(this)"  data-page="${i + 1}">${i+1}</a></li>`
            }
            var paginationHtml = ""
            if (pagingbegin > 1)
                paginationHtml = ` 
                <li>
                  <a href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>`;
            paginationHtml += pages;
            if (pagingend < maxPage)
                paginationHtml += ` 
                    <li>
                      <a href="#" aria-label="Next">
                        <span aria-hidden="true">&raquo;</span>
                      </a>
                    </li>`
            paginationHtml = `<nav aria-label="Page navigation">
                        <ul class="pagination">
                            ${paginationHtml}                           
                        </ul>
                    </nav>`
            $("#pagination").html(paginationHtml)
        }

        function getPage() {
            return $("input[name=Page]").val()
        }
        function getPageSize() {
            return $("input[name=PageSize]").val()
        }

        function setPageSize(size) {
            $("input[name=PageSize]").val(size)
        }

        function gotoPageClick(target) {
            //e.preventDefault();
            $("input[name=Page]").val($(target).attr("data-page"))
            console.log($(target).attr("data-page"))
            doFilterSearch()
        }

        doFilterSearch()

        $('.btn-filter').click(doFilterSearch)
        $('.btn-filter-clear').click(() => {
            $('input[type=checkbox]').prop('checked',false);})
    </script>
}